<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои параметры - BikeFit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/add_anthro.css') }}">
</head>
<body>
    <header>
        <h1>Мои параметры</h1>
        <button class="btn btn-primary" onclick="window.location.href='/dashboard'">← В меню</button>
    </header>

    <div class="page-wrapper">
        <div class="container anthro-container">
            <h2 class="text-center">Ваши измерения</h2>
    
            <div id="error-container" class="error-container" style="display: none;"></div>
            <div id="success-container" class="success-container" style="display: none;"></div>
            

            <form id="anthroForm" class="anthro-form">
        <div class="form-section">
            <h3>Основные параметры</h3>
            
            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/height.png" alt="Рост">
                </div>
                <span class="field-label">Рост, см</span>
                <div class="field-input">
                    <input type="number" step="1" name="height" placeholder="170">
                    <div class="field-error" id="height-error"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Нижние конечности</h3>
            
            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/hip.png" alt="Длина бедра">
                </div>
                <span class="field-label">Длина бедра, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="hip" placeholder="450">
                    <div class="field-error" id="hip-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/lowerLeg.png" alt="Длина голени">
                </div>
                <span class="field-label">Длина голени, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="lowerLeg" placeholder="400">
                    <div class="field-error" id="lowerLeg-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/footLength.png" alt="Длина стопы">
                </div>
                <span class="field-label">Длина стопы, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="footLength" placeholder="260">
                    <div class="field-error" id="footLength-error"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Верхние конечности и туловище</h3>
            
            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/torsoMax.png" alt="Длина туловища">
                </div>
                <span class="field-label">Длина туловища, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="torsoMax" placeholder="500">
                    <div class="field-error" id="torsoMax-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/upperarm.png" alt="Длина плеча">
                </div>
                <span class="field-label">Длина плеча, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="upperarm" placeholder="320">
                    <div class="field-error" id="upperarm-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/forearm.png" alt="Длина предплечья">
                </div>
                <span class="field-label">Длина предплечья, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="forearm" placeholder="280">
                    <div class="field-error" id="forearm-error"></div>
                </div>
            </div>
        </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success btn-lg">Сохранить данные</button>
                </div>
            </form>
        </div>
    </div>

<script src="{{ url_for('static', filename='js/tooltip-position.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
<script type="module">
import { errorHandler } from '/static/js/error_handler.js';

// Функции для работы с ошибками полей
function showFieldError(fieldName, message) {
    const input = document.querySelector(`input[name="${fieldName}"]`);
    const errorDiv = document.getElementById(`${fieldName}-error`);
    
    if (input) {
        input.classList.add('error');
    }
    
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';  // Явно устанавливаем display
        errorDiv.classList.add('show');
    }
}

function clearFieldError(fieldName) {
    const input = document.querySelector(`input[name="${fieldName}"]`);
    const errorDiv = document.getElementById(`${fieldName}-error`);
    
    if (input) {
        input.classList.remove('error');
    }
    
    if (errorDiv) {
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';  // Явно скрываем
        errorDiv.classList.remove('show');
    }
}

function clearAllFieldErrors() {
    const inputs = document.querySelectorAll('input.error');
    inputs.forEach(input => {
        input.classList.remove('error');
    });
    
    const errorDivs = document.querySelectorAll('.field-error');
    errorDivs.forEach(div => {
        div.textContent = '';
        div.style.display = 'none';  // Явно скрываем
        div.classList.remove('show');
    });
}

document.addEventListener('DOMContentLoaded', async () => {
    errorHandler.init('error-container', 'success-container');

    // Загрузка существующих данных
    try {
        const response = await fetch('/fits/get_anthropometry', {
            credentials: "include"
        });
        
        const result = await response.json();

        if (result.success && result.data) {
            const form = document.getElementById('anthroForm');
            Object.keys(result.data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input && result.data[key] !== null) {
                    // Округляем до целого числа при отображении
                    input.value = Math.round(parseFloat(result.data[key]));
                }
            });
        }
    } catch (err) {
        console.error('Не удалось загрузить данные:', err);
    }

    // Обработка отправки формы
    document.getElementById("anthroForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        errorHandler.clearErrors();
        clearAllFieldErrors();
        
        const form = e.target;
        const formData = new FormData(form);

        // Список обязательных полей
        const requiredFields = ['height', 'hip', 'lowerLeg', 'footLength', 'torsoMax', 'upperarm', 'forearm'];
        const fieldNames = {
            'height': 'Рост',
            'hip': 'Длина бедра',
            'lowerLeg': 'Длина голени',
            'footLength': 'Длина стопы',
            'torsoMax': 'Длина туловища',
            'upperarm': 'Длина плеча',
            'forearm': 'Длина предплечья'
        };
        
        // Проверка заполнения обязательных полей
        let hasEmptyFields = false;
        requiredFields.forEach(field => {
            const value = formData.get(field);
            if (!value || value.trim() === '') {
                showFieldError(field, `${fieldNames[field]} обязательно для заполнения`);
                hasEmptyFields = true;
            }
        });
        
        if (hasEmptyFields) {
            errorHandler.showGeneralError('Заполните все обязательные поля', 'warning');
            return;
        }

        const data = {};
        formData.forEach((value, key) => {
            // Используем parseInt для целых чисел
            data[key] = value ? parseInt(value, 10) : null;
        });

        // Отправка данных
        try {
            const response = await fetch("/fits/add_anthropometry", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                errorHandler.showSuccess('Данные успешно сохранены!', () => {
                    window.location.href = '/dashboard';
                });
            } else if (result.errors && Array.isArray(result.errors)) {
                // Обработка ошибок валидации от бекенда
                let hasGeneralError = false;
                
                result.errors.forEach(error => {
                    if (error.field === 'data' || error.field === 'general') {
                        errorHandler.showGeneralError(error.message, 'error');
                        hasGeneralError = true;
                    } else if (error.field) {
                        showFieldError(error.field, error.message);
                    }
                });
                
                if (!hasGeneralError && result.errors.length > 0) {
                    errorHandler.showGeneralError('Исправьте ошибки в полях', 'error');
                }
            } else if (result.error) {
                errorHandler.showGeneralError(result.error, 'error');
            } else {
                errorHandler.showGeneralError('Произошла неизвестная ошибка', 'error');
            }
        } catch (error) {
            console.error('Network error:', error);
            errorHandler.showGeneralError('Ошибка сети. Проверьте подключение к интернету и попробуйте снова.', 'error');
        }
    });
});
</script>