<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Добавить антропометрию</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/add_anthro.css') }}">
</head>
<body>
<div class="container anthro-container">
    <div class="top-bar">
        <button class="btn btn-primary" onclick="window.location.href='/dashboard'">В меню</button>
    </div>

    <h2>Антропометрические данные</h2>
    
    <div id="error-container" class="error-container" style="display: none;"></div>
    <div id="success-container" class="success-container" style="display: none;"></div>
    
    <form id="anthroForm" class="anthro-form">
        <div class="form-section">
            <h3>Основные параметры</h3>
            
            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/height.png" alt="Рост">
                </div>
                <span class="field-label">Рост, см</span>
                <div class="field-input">
                    <input type="number" step="1" name="height" required placeholder="170">
                    <div class="field-error" id="height-error"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Нижние конечности</h3>
            
            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/hip.png" alt="Длина бедра">
                </div>
                <span class="field-label">Длина бедра, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="hip" required placeholder="450">
                    <div class="field-error" id="hip-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/lowerLeg.png" alt="Длина голени">
                </div>
                <span class="field-label">Длина голени, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="lowerLeg" required placeholder="400">
                    <div class="field-error" id="lowerLeg-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/footLength.png" alt="Длина стопы">
                </div>
                <span class="field-label">Длина стопы, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="footLength" required placeholder="260">
                    <div class="field-error" id="footLength-error"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Верхние конечности и туловище</h3>
            
            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/torsoMax.png" alt="Длина туловища">
                </div>
                <span class="field-label">Длина туловища, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="torsoMax" required placeholder="600">
                    <div class="field-error" id="torsoMax-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/upperarm.png" alt="Длина плеча">
                </div>
                <span class="field-label">Длина плеча, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="upperarm" required placeholder="320">
                    <div class="field-error" id="upperarm-error"></div>
                </div>
            </div>

            <div class="field-row">
                <div class="tooltip">?
                    <img src="static/png/hints/forearm.png" alt="Длина предплечья">
                </div>
                <span class="field-label">Длина предплечья, мм</span>
                <div class="field-input">
                    <input type="number" step="1" name="forearm" required placeholder="280">
                    <div class="field-error" id="forearm-error"></div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-success btn-lg">Сохранить данные</button>
        </div>
    </form>
</div>

<script>
function clearErrors() {
    const errorContainer = document.getElementById('error-container');
    const successContainer = document.getElementById('success-container');
    
    errorContainer.style.display = 'none';
    errorContainer.innerHTML = '';
    successContainer.style.display = 'none';
    successContainer.innerHTML = '';
    
    document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
    document.querySelectorAll('input').forEach(el => el.classList.remove('error'));
}

function showErrors(errors) {
    errors.forEach(error => {
        const fieldError = document.getElementById(`${error.field}-error`);
        const input = document.querySelector(`[name="${error.field}"]`);
        
        if (fieldError && input) {
            fieldError.textContent = error.message;
            input.classList.add('error');
        } else if (error.field === 'data' || error.field === 'general') {
            const errorContainer = document.getElementById('error-container');
            errorContainer.textContent = error.message;
            errorContainer.style.display = 'block';
        }
    });
}

function showSuccess(message) {
    const successContainer = document.getElementById('success-container');
    successContainer.textContent = message;
    successContainer.style.display = 'block';
    
    // Скрыть через 3 секунды
    setTimeout(() => {
        successContainer.style.display = 'none';
    }, 3000);
}

document.getElementById("anthroForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearErrors();
    
    const form = e.target;
    const formData = new FormData(form);

    const data = {};
    formData.forEach((value, key) => {
        data[key] = value ? parseFloat(value) : null;
    });

    try {
        const response = await fetch("/fits/add_anthropometry", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
            showSuccess("✅ Данные успешно сохранены!");
        } else {
            if (result.errors) {
                showErrors(result.errors);
            } else {
                const errorContainer = document.getElementById('error-container');
                errorContainer.textContent = result.error || "Не удалось сохранить данные";
                errorContainer.style.display = 'block';
            }
        }
    } catch (err) {
        console.error("Ошибка при отправке:", err);
        const errorContainer = document.getElementById('error-container');
        errorContainer.textContent = "Ошибка сети. Попробуйте еще раз.";
        errorContainer.style.display = 'block';
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/fits/get_anthropometry', {
            credentials: "include"
        });
        
        const result = await response.json();

        if (result.success && result.data) {
            const form = document.getElementById('anthroForm');
            Object.keys(result.data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input && result.data[key] !== null) {
                    input.value = result.data[key];
                }
            });
        }
    } catch (err) {
        console.error('Не удалось загрузить данные:', err);
    }
});
</script>
</body>
</html>